{% extends 'base.html' %} 
{% block content %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>


<style>
    input[type=text],
    select {
        width: 100%;
        padding: 12px 20px;
        margin: 8px 0;
        display: block;
        border: 0.5px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    
    input[type=submit] {
        width: 20%;
        text-align: center;
        background-color: #4CAF50;
        color: white;
        padding: 14px 20px;
        margin: 8px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    input[type=submit]:hover {
        background-color: #45a049;
        text-align: center;
    }
    
    input[type=button] {
        width: 10%;
        text-align: center;
        background-color: #4CAF50;
        color: white;
        padding: 6px 6px;
        margin: 8px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    input[type=button]:hover {
        background-color: #45a049;
        text-align: center;
    }
</style>
<br>
<br>
<h4 align="center">M21</h4>
<h2 align="center" ></h2>
<h2 align="center" >GATE ATTENDANCE CARD</h2>
<br><br>
<form action="{% url 'm21view' %}" method="POST"> {% csrf_token %}
    <div class="container">
        <table class="table">
                <tr>
                    <td>
                    <label for="sno"><b>SHOP SECTION NO/शॉप अधी. :</b></label>
                  

                    <select class="form-control" id="shop_sec" name="shop_sec" required>
            <option id="op_shop" selected disabled hidden>Select Shop Section</option>
            {% if lenm == 1 %}
                <option selected readonly>{% for role in roles %}{{role}}{% endfor %}</option>
                {{role}}
            {% endif %}
            {% if lenm > 1 %}
            {% for role in roles %}
            {{role}}
              <option>{{role}}</option>
            {% endfor %}
            {% endif %}
                    </select>
                    </td>
                    <td>
                                <label for="staff_no"><b>EMPLOYEE NO/क्रम सं.:</b></label>
                                <select class="form-control" id="staff_no" name="staff_no" required>
                        <option id="op_emp" selected disabled hidden>Select EMPLOYEE NO</option>
                        
                                </select>
                    </td>
                    <td>
                                <label for="yymm"><b>YEAR-MONTH:</b></label>
                                <select class="form-control" id="yymm" name="yymm" required>
                        <option id="op_yymm" selected disabled hidden>Select YEAR-MONTH</option>
                        
                                </select>
                    </td>
                </tr>
        </table>
        <input type="hidden" name="inoutnum" id="inoutnum" value="0" />
        <input type="submit" value="Proceed" name="proceed" id="myproceed" hidden/>
    </div>
<br><br> {% if sub == 1 %}
<div id="print" style="align:center" >
<input type="hidden" name="len" value="{{len}}">
<table align="center">  
    <tr>
        <th>SHOP SECTION/शाप विभाग:</th> 
        <td><u>{{shop_sec}}</u></td>
        <input type="hidden" name="shop_sec" value="{{shop_sec}}">
        
    </tr>
    <tr>
        <th>EMPLOYEE NO/क्रम सं.:</th> 
        <td><u>{{staff_no}}</u></td>
        <input type="hidden" name="staff_no" value="{{staff_no}}">
    </tr>
    <tr>
        
        <th>NAME/नाम:</th>
        {% for i in obj %}
        <td>
            <u>{{i.name}}</u>
            <input type="hidden" name="name" value="{{i.name}}">
        </td>
        {% endfor %}
    </tr>
    <tr>
        <th>CAT/को.:</th>
        {% for i in obj %}
        <td>
            <u>{{i.cat}}</u>
            <input type="hidden" name="cat" value="{{i.cat}}">
        </td>
        {% endfor %}
    </tr>
    <tr>
        <th>DESIGNATION/पद.:</th>
        {% for i in obj %}
        <td>
            <u>{{i.desgn}}</u>
            <input type="hidden" name="desgn" value="{{i.desgn}}">
        </td>
        {% endfor %}
    </tr>

</table>
<br><br>
<table border="2" align="center">
    <tr>
        <th>OVERTIME DATA FOR LAST WEEK/पिछले सप्ताह के ओवर टाइम के आकड़े</th>
        <th><center>HOURS/घंटे</center></th>
        <th><center>AMOUNT/राशि</center></th>
    </tr>
    <tr>
        <th><center>1 HOUR TIME/१ घंटे तक का समय </center></th>
        <th><input type="text" name="hour" value="" required></th>
        <th><input type="text" name="amount" value="" required></th>
    </tr>
    <tr>
        <th>PAID OVERTIME AT BASE RATE/मूल दर पर भुगतान वाला ओवर टाइम</th>
        <th><input type="text" name="hour" value="" required></th>
        <th><input type="text" name="amount" value="" required></th>
    </tr>
</table>





<table border="2" align="center">
    <tr>
        
        <th rowspan="2">DATE</th>
        <th colspan="2">WORK TIME</th>
        <th colspan="2">OVER TIME WORK</th>
        <th rowspan="2">TOTAL TIME</th>
    </tr>
    <tr>

        <th>IN</th>
        <th>OUT</th>
        <th>IN</th>
        <th>OUT</th>
        
        
        
    </tr>
            

    {% for i in ran %}
    <tr>
    <td>
        {% if i.date %}
        <input type="date" id="date"  class="myinp" value="{{obj1.date}}" name="date{{ forloop.counter }}" required >
        {% else %}
        <input type="date" id="date"  class="myinp" value="0" name="date{{ forloop.counter }}" required>
        {% endif %}  
    </td>
    
    <td>
        {% if i.in1 %}
        <input type="time" id="in1"  class="myinps" value="{{i.in1}}" name="in1{{ forloop.counter }}" required >
        {% else %}
        <input type="time" id="in1"  class="myinps" value="0" name="in1{{ forloop.counter }}" required>
        {% endif %}  
      
      </td> 
      <td>
       {% if i.out %}
          <input type="time" id="out"  class="myinps" value="{{i.out}}" name="out{{ forloop.counter }}" required >
        {% else %}
          <input type="time" id="out"  class="myinps" value="0" name="out{{ forloop.counter }}" required>
        {% endif %}    
  
       </td>
       <td>
        {% if i.in2 %}
        <input type="time" id="in2"  class="myinps" value="{{i.in2}}" name="in2{{ forloop.counter }}" required >
        {% else %}
        <input type="time" id="in2"  class="myinps" value="0" name="in2{{ forloop.counter }}" required>
        {% endif %}  
      
      </td> 
      <td>
       {% if i.out2 %}
          <input type="time" id="out2"  class="myinps" value="{{i.out2}}" name="out2{{ forloop.counter }}" required >
        {% else %}
          <input type="time" id="out2"  class="myinps" value="0" name="out2{{ forloop.counter }}" required>
        {% endif %}    
  
       </td>
       <td>
       {% if i.total_time %}
            <input type="text" id="total_time{{ forloop.counter }} "   value="{{i.total_time}}"  name="total_time{{ forloop.counter }}"   >
        {% else %}
            <input type="text" id="total_time{{ forloop.counter }} "   value="0" name="total_time{{ forloop.counter }}"  >
        {% endif %}  
        </td> 
    </tr>
          
               
    {% endfor %}

</table>
<div id="items">

</div>
<center>
<input  type="button" id="add" value="Add Operations" style="width: 150px;"/>
</center>
<br><br><br>
<table border="2" align="center">
<tr>
    <th></th>
    <th>DAY</th>
    <th>HOURS</th>
</tr>
<tr>
    <th>Cut time/कटौती का समय</th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>Additional wages/अतिरिक्त मजदूरी</th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>Factory half O.T./फैक्ट्री आधि ओ.टी. </th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>General O.T./सामान्य  ओ.टी. </th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>Night allowance hours/रात्रि भत्ते के घंटे </th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>Half holiday/अर्द्ध औ.वे. की छुट्टी </th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>Pay off leave/औसन वेतन की छुट्टी  </th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>Number of unused holidays/उपयोग न हुई छुट्टियों की सं.</th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
<tr>
    <th>Supplementary Holidays Given/दी गयी प्रति पूरक छुट्टियां</th>
    <th><input type="text" name="" value="" required></th>
    <th><input type="text" name="" value="" required></th>
</tr>
</table>
<table align="center">
<tr>
    <th >EMPLOYEE NO./संगड़क.</th>
    <th></th>
    <th></th>
    <th></th>
    <th></th>
    <th></th>
    <th>EMPLOYEE NAME/जांचकर्ता.</th>
</tr>
</table>
<center>
    <input type="submit" name="proceed" value="Submit">
    <input type="button" onclick="printDiv()" value="Print">
</center> 
</div>
{% endif %}
</form>

<script type="text/javaScript">
document.querySelector("#shop_sec").addEventListener('change',(e)=>{
                  e.preventDefault();
                  var shop_sec = $("#shop_sec").val()
                  var data = {shop_sec};
                    $.ajax({
                      type : 'GET',
                      url : "{% url 'm21getempno' %}",
                      dataType : 'json',
                      data : data,
                      success : function(response){
                        var elementsadded = document.querySelectorAll(".neweleempno");
                            if(elementsadded.length>0){
                                var elementsaddedarr = Array.from(elementsadded);
                                elementsaddedarr.forEach((el)=> el.remove());
                                document.querySelector("#op_emp").selected=true;
                                document.querySelector("#op_yymm").selected=true;
                                
                                 
                             }
                            var brarr,mystr,html;
                            brarr = response.map((el)=>el.staff_no);
                            mystr = "";
                            brarr.forEach((el,index)=>{
                              html = `<option class="neweleempno">${brarr[index]}</option>`
                              mystr = html.concat(mystr);
                            });
                            html = "";
                            document.querySelector("#staff_no").insertAdjacentHTML('beforeend',mystr);
                            mystr=""; 
                      }
                        })
              })
document.querySelector("#staff_no").addEventListener('change',(e)=>{
    e.preventDefault();
       
        var staff_no = $("#staff_no").val();
        var shop_sec = $("#shop_sec").val()
        var data = {shop_sec,staff_no};
      
        
        $.ajax({
                type : 'GET',
                url : "{% url 'm21getyymm' %}",
                dataType : 'json',
                data : data,
                success : function(response){
                var elementsadded = document.querySelectorAll(".neweleyymm");
                    if(elementsadded.length>0){
                        var elementsaddedarr = Array.from(elementsadded);
                        elementsaddedarr.forEach((el)=> el.remove());
                        
                        document.querySelector("#op_yymm").selected=true;
                                    
                }
                                var brarr,mystr,html;
                                brarr = response.map((el)=>el.yymm);
                                mystr = "";
                                brarr.forEach((el,index)=>{
                                  html = `<option class="neweleyymm">${brarr[index]}</option>`
                                  mystr = html.concat(mystr);
                                });
                                html = "";
                                document.querySelector("#yymm").insertAdjacentHTML('beforeend',mystr);
                                mystr=""; 
                          }
                            })
                  })



document.querySelector("#yymm").addEventListener('change',(e)=>{

document.querySelector("#myproceed").click();
})
document.addEventListener('keypress',(event)=>{
if(event.keyCode===13){
    event.preventDefault();
}
})

function printDiv() {
     var printContents = document.getElementById("print").innerHTML;

       var style = "<style>";
        style = style + "table {width: 100%;font: 17px Calibri;}";
        style = style + "table, th, td {border: solid 1px #DDD; border-collapse: collapse;";
        style = style + "padding: 2px 3px;text-align: left;}";
        style = style + "</style>";
      var win = window.open('', '', 'height=500,width=500');

        win.document.write('<html><head>');

        win.document.write('<title>M21 GATE ATTENDANCE CARD</title>');
        win.document.write(style);
        win.document.write('</head>');
        win.document.write('<body>');
        win.document.write(printContents);
        win.document.write('</body></html>');

        win.print();
        win.close();

}

var j=0;
$("#add").click(function(e){
        event.preventDefault()
        j++;
        console.log(j);
        
 
        var date="date"+String(j)
        
        var in1="in1"+String(j);
        var out="out"+String(j);
        var in2="in2"+String(j);
        var out2="out2"+String(j);
        var outid="'"+out+"'";
        var in1id="'"+out+"'";
        var out2id="'"+out2+"'";
        var in2id="'"+out2+"'";
        
        var total_time="total_time"+String(j)
        
        
        var htAppend='<div><table id="customers" border="2" align="center"><tr>'+'<td ><input type="date" id='+date+' name='+date+' required /></td >'+'<td ><input type="time" id='+in1+' name='+in1+' onchange="tottime('+in1id+')" /></td >'+'<td  height="50"><input type="time" id='+out+' name='+out+'  onchange="tottime('+outid+')" /></td>'+'<td ><input type="time" id='+in2+' name='+in2+' onchange="tottime('+in2id+')" /></td >'+'<td  height="50"><input type="time" id='+out2+' name='+out2+'  onchange="tottime('+out2id+')" /></td>'+'<td  height="50"><input type="text" id='+total_time+' name='+total_time+'></td>';
        htAppend=htAppend+'</tr></table>'+'</div>';
        $('#items').append(htAppend);
        document.getElementById("inoutnum").value=j;


$( document ).ready(function() {
    // console.log( "ready!" );
    tottime('in11');
});
    // console.log( "ready!" );
    function tottime(id) {
      console.log("id=");
      console.log(id);
      var ad=id.includes("add");
      
      if(ad==false)
      {
      var inn=id.includes("in");
      console.log(inn);
      if(inn)
      {
        var res = id.split("in1");
        console.log(res[1]);
        var outid="#out"+res[1];
    var timeOfCall = $('#'+id).val(),
        timeOfResponse = $(outid).val(),
        hours = timeOfResponse.split(':')[0] - timeOfCall.split(':')[0],
        minutes = timeOfResponse.split(':')[1] - timeOfCall.split(':')[1];

    minutes = minutes.toString().length<2?'0'+minutes:minutes;
    if(minutes<0){ 
        hours--;
        minutes = 60 + minutes;
    }
    hours = hours.toString().length<2?'0'+hours:hours;
    console.log("total_time=",hours + ':' + minutes,'#total_time'+String(res[1]));
    $('#total_time'+String(res[1])).val(hours + ':' + minutes);
      }
      else
      {
      var res = id.split("out");
        console.log(res[1]);
        var inid="#in1"+res[1];
    var timeOfCall = $(inid).val(),
        timeOfResponse = $('#'+id).val(),
        hours = timeOfResponse.split(':')[0] - timeOfCall.split(':')[0],
        minutes = timeOfResponse.split(':')[1] - timeOfCall.split(':')[1];

    minutes = minutes.toString().length<2?'0'+minutes:minutes;
    if(minutes<0){ 
        hours--;
        minutes = 60 + minutes;
    }
    hours = hours.toString().length<2?'0'+hours:hours;
    console.log("total_time=",hours + ':' + minutes,'#total_time'+String(res[1]));

    $('#total_time'+String(res[1])).val(hours + ':' + minutes);
      }
      }
      else{
      var inn=id.includes("in");

        if(inn)
      {
        var res = id.split("in1add");
        console.log(res[1]);
        var outid="#outadd"+res[1];
    var timeOfCall = $('#'+id).val(),
        timeOfResponse = $(outid).val(),
        hours = timeOfResponse.split(':')[0] - timeOfCall.split(':')[0],
        minutes = timeOfResponse.split(':')[1] - timeOfCall.split(':')[1];

    minutes = minutes.toString().length<2?'0'+minutes:minutes;
    if(minutes<0){ 
        hours--;
        minutes = 60 + minutes;
    }
    hours = hours.toString().length<2?'0'+hours:hours;
    console.log("total_time_add=",hours + ':' + minutes,'#total_time_add'+String(res[1]));

    $('#total_time_add'+String(res[1])).val(hours + ':' + minutes);
      }
      else
      {
      var res = id.split("outadd");
        console.log(res[1]);
        var inid="#in1add"+res[1];
    var timeOfCall = $(inid).val(),
        timeOfResponse = $('#'+id).val(),
        hours = timeOfResponse.split(':')[0] - timeOfCall.split(':')[0],
        minutes = timeOfResponse.split(':')[1] - timeOfCall.split(':')[1];

    minutes = minutes.toString().length<2?'0'+minutes:minutes;
    if(minutes<0){ 
        hours--;
        minutes = 60 + minutes;
    }
    hours = hours.toString().length<2?'0'+hours:hours;
    console.log("total_time_add=",hours + ':' + minutes,'#total_time_add'+String(res[1]));

    $('#total_time_add'+String(res[1])).val(hours + ':' + minutes);
      }
      }
    
  }




   



    }); 
</script>








{% endblock content %}       

                 
                            
